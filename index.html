<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Test Telegram WebApps API</title>
   <script src="https://telegram.org/js/telegram-web-app.js"></script> <!--Подключаем скрипт от телеграм-->
   <style>
      body{
         color: var(--tg-theme-text-color);
         background: var(--tg-theme-bg-color);
         display: flex;
         flex-direction: column;
         align-items: center;
         font-size: 18px;
      }

      .hint{
         color: var(--tg-theme-hint-color);
      }

      .link{
         color: var(--tg-theme-link-color);
      }

      .button{
         background: var(--tg-theme-button-color);
         color: var(--tg-theme-button-text-color);
         border: none;
         font-size: 18px;
      }

      .button:not(:last-child){
         margin-bottom: 20px
      }

      #usercard{
         text-align: center;
      }
   </style>
</head>

<body>
   <!--<button id="btn" class="button">Show/Hide Main Button</button> <!--Кнопка, чтобы скрыть / показать основную кнопку-->
   <!--<button id="btnED" class="button">Enable/Disable Main Button</button> <!--Кнопка, чтобы сделать кнопку активной/неактивной-->
   <!--Выводим наш гет в base64-->
   <div id="div-get">
   </div>
   <!--Выводим декодированный гет-->
   <form>
      <div id="div-form">
      </div>
   </form>
   <!--Выводим имя бренда-->
   <form>
      <label for = "div-brand_name">Ваш бренд:</label>
      <span id="div-brand_name">
      </span>
   </form>
   <!--Выводим тип отчёта-->
   <form>
      <label for = "div-order_type_1">Ваш тип отчёта:</label>
      <span id="div-order_type_1">
      </span>
   </form>
   <!--Выводим поля из отчёта тип = 1-->
   <!--http://shurick31.narod.ru/dynamic_forms.html-->
   <form name="links" method="post">
      <table id="tbl1">
      </table>
   </form>
</body>

<script>
   //функция декодирования base64 в str с ru
   function b64_to_utf8(str) {
	return decodeURIComponent(escape(window.atob(str)));
}

   url=new URL(document.location.href) //Получаем URL
   //document.getElementById('div-get').innerHTML=url.searchParams.get('data'); // Выводим параметр data в лейбл
   data_base64=url.searchParams.get('data');// Выводим параметр data в переменную
   data_base64=data_base64.replace(/-/g, "+");// Заменяем все - на + (т.к. браузер сам интерпритирует +)
   data=b64_to_utf8(data_base64) // Декодируем
   //document.getElementById('div-form').innerHTML=data; //Выводим в лейбл
   data=JSON.parse(data); // Парсим str в JSON
   console.log(data); // Выводим в консоль браузера

   // надо пробежаться по объекту data и вывести данные в формы
   document.getElementById('div-brand_name').innerHTML=data[0].split(';')[1].split(':')[1];
   document.getElementById('div-order_type_1').innerHTML=data[1][0].split(';')[1].split(':')[1];

   function _build_form1(data) {
      var code ='';
      for (key in data[1][1]) {
         console.log("Ключ = " + key);
         console.log("Значение = " + data[1][1][key]);
         //var tbodyRef = document.getElementById('tbl1');
         //var newRow = tbodyRef.insertRow();
         //newRow.innerHTML = data[1][1][key];
         var a= data[1][1][key].split(';');
         code = code+' <TR><TD><B>'+a[1].split(':')[1]+':<B></TD><TD><INPUT NAME="'+a[0].split(':')[1]+'" SIZE=20 onBlur="this.value=this.value.toUpperCase()"></TD></TR>'

      }
      document.getElementById('tbl1').innerHTML=code
   }
   _build_form1(data)

   let tg = window.Telegram.WebApp; //получаем объект webapp телеграма
   tg.expand(); //расширяем на все окно
   tg.MainButton.text = "Changed Text"; //изменяем текст кнопки
   tg.MainButton.setText("Changed Text1"); //изменяем текст кнопки иначе
   tg.MainButton.textColor = "#F55353"; //изменяем цвет текста кнопки
   tg.MainButton.color = "#143F6B"; //изменяем цвет бэкграунда кнопки
   tg.MainButton.setParams({"color": "#143F6B"}); //так изменяются все параметры
   let btn = document.getElementById("btn"); //получаем кнопку скрыть/показать

   //кнопки
   btn.addEventListener('click', function(){ //вешаем событие на нажатие html-кнопки
      if (tg.MainButton.isVisible){ //если кнопка показана
         tg.MainButton.hide() //скрываем кнопку
      }
      else{ //иначе
         tg.MainButton.show() //показываем
      }
   });

   let btnED = document.getElementById("btnED"); //получаем кнопку активировать/деактивировать
   btnED.addEventListener('click', function(){ //вешаем событие на нажатие html-кнопки
      if (tg.MainButton.isActive){ //если кнопка показана
         tg.MainButton.setParams({"color": "#E0FFFF"}); //меняем цвет
         tg.MainButton.disable() //скрываем кнопку
      }
      else{ //иначе
         tg.MainButton.setParams({"color": "#143F6B"}); //меняем цвет
         tg.MainButton.enable() //показываем
      }
   });

   Telegram.WebApp.onEvent('mainButtonClicked', function(){
      tg.sendData("some string that we need to send");
      //при клике на основную кнопку отправляем данные в строковом виде
   });


   let usercard = document.getElementById("usercard"); //получаем блок usercard

   let profName = document.createElement('p'); //создаем параграф
   profName.innerText = `${tg.initDataUnsafe.user.first_name}
   ${tg.initDataUnsafe.user.last_name}
   ${tg.initDataUnsafe.user.username} (${tg.initDataUnsafe.user.language_code})`;
   //выдем имя, "фамилию", через тире username и код языка
   usercard.appendChild(profName); //добавляем

   let userid = document.createElement('p'); //создаем еще параграф
   userid.innerText = `${tg.initDataUnsafe.user.id}`; //показываем user_id
   usercard.appendChild(userid); //добавляем


   //работает только в attachment menu
   // let pic = document.createElement('img'); //создаем img
   // pic.src = tg.initDataUnsafe.user.photo_url; //задаём src
   // usercard.appendChild(pic); //добавляем элемент в карточку
</script>
</html>